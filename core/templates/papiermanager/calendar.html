<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Schichtkalender</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    background-color: #f0f0f0;
  }

  /* Sidebar Styling */
  .sidebar {
    width: 220px;
    background-color: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    height: 100vh;
    box-sizing: border-box;
  }

  .sidebar h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-weight: normal;
  }

  .menu-links a {
    color: white;
    text-decoration: none;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.3s;
    font-weight: 600;
    display: block;
  }

  .menu-links a:hover {
    background-color: #34495e;
  }

  .sidebar-bottom {
    margin-top: auto;
  }

  .btn-logout {
    color: white;
    background-color: #e74c3c;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    font-weight: 600;
    text-align: left;
    display: inline-block;
    text-decoration: none;
    transition: background-color 0.3s;
    width: fit-content;
    cursor: pointer;
    border: none;
  }

  .btn-logout:hover {
    background-color: #c0392b;
  }

.dropdown-content a,
.dropdown-content button {
            font-size: 0.9rem;
            font-weight: 500;
            padding-left: 1.5rem;
        }

  /* Hauptbereich Styling */
  .main-content {
    flex-grow: 1;
    padding: 2rem;
    overflow-y: auto;
    background: white;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    margin: 1rem;
    border-radius: 8px;
  }

  h1 {
    color: #333;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  #calendar {
    max-width: 900px;
    margin: 0 auto;
  }

  /* Legende unter dem Kalender */
  .legend {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1rem;
    gap: 12px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #333;
  }

  .legend-color {
    width: 14px;
    height: 14px;
    margin-right: 6px;
    border-radius: 3px;
    border: 1px solid #999;
  }

  /* Modal Overlay */
  #modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right:0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  /* Modal Fenster */
  .modal {
    background: white;
    border-radius: 6px;
    max-width: 400px;
    width: 90%;
    padding: 1rem 1.5rem;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    float: right;
    cursor: pointer;
    color: #666;
  }

  .modal-event {
    margin-bottom: 1rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
  }

  .modal-event:last-child {
    border-bottom: none;
  }

  .dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }

/* Header-Toolbar richtig zentrieren */
.fc-header-toolbar {
  position: relative; /* Basis für absolute Positionierung des Titels */
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fc-header-toolbar .fc-toolbar-title {
  position: absolute;
  left: 50%;
  transform: translateX(-50%) translateY(-15px); /* nach oben verschieben */
  white-space: nowrap;
}

/* Links und rechts Platz lassen, damit sie den Titel nicht verschieben */
.fc-header-toolbar .fc-toolbar-chunk:first-child,
.fc-header-toolbar .fc-toolbar-chunk:last-child {
  flex: 1;
  display: flex;
  justify-content: flex-start; /* rechte Seite ggf. auf flex-end setzen, falls Buttons rechts */
}

/* Optional: rechte Buttons nach rechts schieben */
.fc-header-toolbar .fc-toolbar-chunk:last-child {
  justify-content: flex-end;
}

</style>

</head>
<body>


<nav class="sidebar">
  <h2>Menü</h2>
  <div class="menu-links">
    <a href="{% url 'my_shifts' %}">Meine Schichten</a>
    <a href="{% url 'calendar' %}">Schichtkalender</a>
    {% if user.is_superuser %}
      <a href="{% url 'user_management' %}">Benutzer verwalten</a>
    {% endif %}

    {% if user.is_authenticated %}
    <!-- Dropdown für "Schichten verwalten" -->
    <div class="dropdown">
      <a href="#" onclick="toggleDropdown('shiftsDropdown'); return false;">Schichten &#9662;</a>
      <div class="dropdown-content" id="shiftsDropdown" style="display:none;">
        <a href="{% url 'add_shift' %}">Hinzufügen</a>
        <a href="{% url 'edit_shift' %}">Bearbeiten</a>
        <a href="{% url 'delete_shift' %}">Löschen</a>
        <a href="#" onclick="event.preventDefault(); if(confirm('Wollen Sie wirklich das Papier nachfüllen und die Mail verschicken?')) { document.getElementById('papierForm').submit(); }">
          Papier nachfüllen
        </a>
        <form id="papierForm" action="{% url 'papier_nachfuellen' %}" method="post" style="display:none;">
          {% csrf_token %}
        </form>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="sidebar-bottom">
    {% if user.is_authenticated %}
      <button class="btn-logout" onclick="confirmLogout()">Abmelden</button>
    {% else %}
      <a href="{% url 'login' %}" class="btn-logout" style="background-color:#007bff; display:inline-block;">Anmelden</a>
    {% endif %}
  </div>
</nav>

<script>
  function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
    } else {
      dropdown.style.display = 'block';
    }
  }
</script>

  <main class="main-content">
    <h1>Schichtkalender</h1>
    <div id='calendar'></div>

    <!-- JSON Script mit User-Farben für die Legende -->
    {{ user_colors|json_script:"user-colors" }}

    <!-- Legende Container (wird per JS befüllt) -->
    <div class="legend" id="legend"></div>
  </main>

  <!-- Modal -->
  <div id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-date" tabindex="-1">
    <div class="modal">
      <button id="modal-close" class="modal-close" aria-label="Schließen">&times;</button>
      <h3>Schichten am <span id="modal-date"></span></h3>
      <div id="modal-body"></div>
    </div>
  </div>

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <script>
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"'`=\/]/g, function(s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        })[s];
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'de',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        events: '{% url "shifts_json" %}',
        eventDisplay: 'background',  // ganztägig farbiges Feld füllen
        dateClick: function(info) {
          var dateStr = info.dateStr;
          var eventsOnDate = calendar.getEvents().filter(function(ev) {
            return ev.startStr === dateStr;
          });

          var modalOverlay = document.getElementById('modal-overlay');
          var modalBody = document.getElementById('modal-body');
          var modalDate = document.getElementById('modal-date');

          modalDate.textContent = dateStr;
          modalBody.innerHTML = '';

          if (eventsOnDate.length === 0) {
            modalBody.innerHTML = '<p>Keine Schichten an diesem Tag.</p>';
          } else {
            eventsOnDate.forEach(function(ev) {
              var username = ev.extendedProps.username || ev.title || 'Unbekannt';
              var description = ev.extendedProps.description || '';
              var color = ev.backgroundColor || ev.background || ev.color || '#9e9e9e';

              var wrapper = document.createElement('div');
              wrapper.className = 'modal-event';
              wrapper.innerHTML = '<div><span class="dot" style="background:' + escapeHtml(color) + '"></span><strong>' + escapeHtml(username) + '</strong></div>'
                                + '<p>' + escapeHtml(description).replace(/\n/g, '<br>') + '</p>';
              modalBody.appendChild(wrapper);
            });
          }

          modalOverlay.style.display = 'flex';
          modalOverlay.focus();
        }
      });

      calendar.render();

      // Legende automatisch aus JSON bauen
      try {
        var legend = document.getElementById('legend');
        var userColorsScript = document.getElementById('user-colors');
        if (userColorsScript && legend) {
          var userColors = JSON.parse(userColorsScript.textContent || '{}');
          Object.keys(userColors).forEach(function(username) {
            var color = userColors[username] || '#9e9e9e';

            var item = document.createElement('span');
            item.className = 'legend-item';

            var colorBox = document.createElement('span');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = color;
            colorBox.setAttribute('aria-hidden', 'true');

            item.appendChild(colorBox);
            item.appendChild(document.createTextNode(' ' + username));
            legend.appendChild(item);
          });
        }
      } catch (e) {
        console.error('Fehler beim Erstellen der Legende:', e);
      }

      // Modal schließen-Button
      document.getElementById('modal-close').addEventListener('click', function() {
        document.getElementById('modal-overlay').style.display = 'none';
      });

      // Klick außerhalb des Modals schließt es auch
      document.getElementById('modal-overlay').addEventListener('click', function(event) {
        if (event.target === this) {
          this.style.display = 'none';
        }
      });
    });

    function confirmLogout() {
      if (confirm('Wirklich abmelden?')) {
        window.location.href = "{% url 'logout' %}";
      }
    }
  </script>
</body>
</html>
